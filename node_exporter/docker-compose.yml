services:
  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    container_name: node_exporter
    restart: unless-stopped
    
    # CRITICAL: Use the host's network and process space to monitor the host OS
    network_mode: host
    pid: host
    
    # CRITICAL: Mount host directories for metrics access.
    # The --path.rootfs=/host argument tells node_exporter where to find the host filesystem.
    # Volumes changed to avoid the /proc conflict
    volumes:
      - /:/host:ro,rslave # Mounts the host's root filesystem (read-only)
      - /sys:/host/sys:ro       # Mounts /sys for hardware/kernel info
      - /proc:/host/proc:ro     # Mounts /proc for process and system stats
      
    # Pass the argument to Node Exporter to look at the mounted host filesystem
    command:
      - '--path.rootfs=/host'
      - '--path.sysfs=/host/sys'
      - '--path.procfs=/host/proc'